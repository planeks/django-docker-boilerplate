# Server provisioning script

Automates server setup using Ansible.

## Before provisioning

1. **Prepare a fresh server**
   - Create an Ubuntu/Debian server on your cloud provider
   - Note the server IP address
   - Make sure the server is accessible via SSH
   - **AWS EC2:** Configure the security group to allow inbound traffic on ports
     22 (SSH), 80 (HTTP), and 443 (HTTPS). Go to EC2 > Security Groups, select
     the group attached to your instance, and add these inbound rules.
     Ansible does not configure security groups automatically.

2. **Configure local environment**
   - Install Ansible: `pip install ansible`
   - Create `ansible/.env.ansible` from template:
     ```bash
     cp ansible/.env.ansible.example ansible/.env.ansible
     ```
   - Edit `ansible/.env.ansible` and set required variables:
     - `DOMAIN_NAME` - your domain (e.g., `example.com`)
     - `SSL_EMAIL` - email for SSL certificates
     - `PROJECT_NAME` - project name (default: `django_app`), used for the app directory name
     - `GIT_REPO_URL` - git repository URL (e.g., `git@github.com:user/repo.git`)
     - `GIT_BRANCH` - branch to deploy (default: `main`)
     - `DB_PASSWORD` - database password (auto-generated in template)

3. **Set up SSH access to server from local environment**

   **AWS EC2:** Use the key pair you selected (or created) when launching the instance.
   ```bash
   # Test connection using your AWS key pair
   ssh -i ~/.ssh/your-key.pem ubuntu@server_ip
   ```
   If you launched without a key pair, use EC2 Instance Connect (browser console) to add your public key:
   ```bash
   # On your local machine - generate a key if you don't have one
   ssh-keygen -t ed25519 -f ~/.ssh/aws-key -N ""
   # Then in EC2 Instance Connect, add the public key on the server
   echo "contents-of-aws-key.pub" >> ~/.ssh/authorized_keys
   # Test connection from local machine
   ssh -i ~/.ssh/aws-key ubuntu@server_ip
   ```

   **DigitalOcean / other providers with password access:**
   ```bash
   ssh-keygen -t ed25519
   ssh-copy-id user@server_ip
   ssh user@server_ip
   ```

4. **Set up repository access**
   Can be done before or after provisioning.
   If done before, the script will clone and deploy automatically.
   If done after, you'll need to deploy manually.
   Steps:
      1. SSH to server and create a key pair: `ssh-keygen -t ed25519`. Don't use a passphrase.
      2. Get the public key: `cat ~/.ssh/id_ed25519.pub`
      3. Go to GitHub and add the public key to GitHub Deploy keys

## Usage

### What the script does

The script runs without pausing:
1. Loads configuration from `ansible/.env.ansible`
2. Generates a GitHub Actions SSH key pair on your local machine (saved at `~/.ssh/github_actions`). You'll need to add the private key to GitHub Secrets after provisioning.
3. Auto-detects git repository and branch
4. Runs the Ansible playbook:
   - Updates system packages
   - Installs Docker and Docker Compose
   - Configures firewall and security
   - Sets up monitoring
   - Creates application directories
   - Authorizes the GitHub Actions SSH key
   - Clones the repository and runs initial deployment


```bash
./scripts/provision-server.sh <cloud_provider> <environment> <server_ip> [ssh_user] [ssh_absolute_key_path]
```

### Examples

AWS production:
```bash
./scripts/provision-server.sh aws production 192.168.0.1
```

DigitalOcean development:
```bash
./scripts/provision-server.sh digitalocean dev 45.55.123.45 root
```

With custom SSH key:
```bash
./scripts/provision-server.sh aws production 192.168.0.1 ubuntu ~/.ssh/my-key.pem
```

## Requirements

- `ansible/.env.ansible` configured (see `.env.ansible.example`)
- SSH access to target server
- Ansible installed locally
- Domain name

## After provisioning

1. **Add GitHub secrets** (required for deployments)
   - Go to: Repository Settings > Secrets and variables > Actions
   - Add the following secrets for your environment:

   | Environment | Host Secret | SSH Key Secret | SSH User (optional) |
   |---|---|---|---|
   | Production | `PROD_HOST` = server IP | `PROD_SSH_KEY` = private key | `PROD_SSH_USER` |
   | Staging | `STAGING_HOST` = server IP | `STAGING_SSH_KEY` = private key | `STAGING_SSH_USER` |
   | Development | `DEV_HOST` = server IP | `DEV_SSH_KEY` = private key | `DEV_SSH_USER` |

   > SSH user defaults to `appuser`. If your server uses a different user
   > (e.g., `ubuntu` on AWS EC2), set the corresponding `*_SSH_USER` secret.
   >
   > Project path defaults to `~/projects/django_app`. If you changed `PROJECT_NAME`
   > in `ansible/.env.ansible`, update the `project-path` input in the deploy workflows.

   To get the private key, run this on your **local machine** (not the server).
   The key pair was auto-generated by `provision-server.sh` during provisioning
   and saved locally at `~/.ssh/github_actions`:
   ```bash
   # On your LOCAL machine - prints the private key to paste into GitHub
   cat ~/.ssh/github_actions
   ```

2. **Verify `.env` on server** - provisioning creates it from the template with generated secrets. Check that values are set:
   ```bash
   ssh -i <your-key> <user>@<server_ip> "grep -E 'SECRET_KEY|POSTGRES_PASSWORD|ALLOWED_HOSTS' ~/projects/<project_name>/.env"
   ```

3. **Reboot server if prompted** by script output

4. **Test deployment** via GitHub Actions or push to the corresponding branch
